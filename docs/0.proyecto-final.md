```
Universidad del Quindío  
Programa de Ingeniería de Sistemas y Computación  
Programación III - Proyecto Final  
Docente: Carlos Andrés Flórez V.
```

# Proyecto Final - Batallas Pokémon

## 1. Objetivo del Proyecto

Implementar una plataforma de batallas Pokémon por turnos en interfaz por consola con:

- Concurrencia (múltiples batallas simultáneas),
- Distribución (batallas ejecutándose en al menos 2 nodos),
- Persistencia en archivos,
- Sistema de progresión por sobres (colección + economía).

El resultado debe ser un sistema programable, testeable y con reglas claras de negocio.

---

## 2. Alcance Obligatorio

El proyecto debe incluir obligatoriamente:

1. Registro e inicio de sesión de entrenadores.
2. Salas de batalla 1v1.
3. Motor de combate por turnos con cálculo de daño.
4. Efectividad de tipos (fuerte/débil/neutro).
5. Estadísticas base, nivel, experiencia y evolución por nivel.
6. Sobres aleatorios para obtener Pokémon.
7. Monedas por victoria para comprar sobres.
8. Múltiples batallas concurrentes.
9. Ejecución distribuida en al menos 2 nodos Elixir.
10. Persistencia de entrenadores, inventario y resultados.
11. Gestión de equipos predefinidos reutilizables por entrenador.

---

## 3. Comandos Mínimos de la Interfaz por Consola

El sistema debe soportar al menos estos comandos:

### 3.1 Cuenta y sesión

- `conectar <usuario> <clave>`: inicia sesión; si no existe, registra.
- `desconectar`: cierra sesión.
- `perfil`: muestra ELO, monedas, inventario resumido.
- `clasificacion`: muestra clasificación global.

### 3.2 Sobres y tienda

- `tienda`: lista tipos de sobre, precio y probabilidades.
- `comprar_sobre <tipo>`: compra un sobre descontando monedas.
- `abrir_sobre <id_sobre|ultimo>`: abre un sobre y agrega Pokémon al inventario.

### 3.3 Salas y combate

- `listar_salas`: lista salas disponibles.
- `crear_sala modo=1v1 tiempo_turno=20`: crea sala.
- `unirse_sala <id_sala>`: se une a sala.
- `crear_equipo <nombre> <p1,p2,p3>`: guarda equipo reutilizable desde inventario.
- `listar_equipos`: lista equipos guardados del entrenador.
- `usar_equipo <nombre>`: carga un equipo guardado para la siguiente batalla.
- `seleccionar_equipo <p1,p2,p3>`: selecciona equipo desde inventario.
- `iniciar_batalla <id_sala>`: inicia combate si hay 2 jugadores listos.
- `ataque <movimiento>`: ejecuta ataque.
- `cambiar <pokemon>`: cambia Pokémon activo.
- `rendirse`: rendición.

---

## 4. Modelo de Datos del Pokémon (Atributos)

Para evitar ambigüedades, el proyecto debe usar nombres consistentes en español para atributos de combate.

Atributos mínimos de un Pokémon en batalla:

- `especie`
- `tipos` (1 o 2 tipos)
- `nivel`
- `experiencia`
- `salud_maxima`
- `salud_actual`
- `ataque`
- `defensa`
- `velocidad` (define orden de turno)
- `movimientos` (nombre, tipo, poder)
- `evolucion_a` (opcional)
- `nivel_evolucion` (opcional)

Si se usan campos persistentes por especie en `pokemon.dat`, se recomienda:

- `salud_base`
- `ataque_base`
- `defensa_base`
- `velocidad_base`

Estándar de nomenclatura obligatorio en este documento:

- usar `velocidad` en lugar de `speed`
- usar `ataque` en lugar de `attack`
- usar `defensa` en lugar de `defense`
- usar `salud` en lugar de `hp`
- usar nombres de movimientos en español y en formato `snake_case` (ej: `pistola_agua`)

---

## 5. Reglas de Negocio (Exactas)

### 5.1 Sobres, inventario y economía

- Al crear cuenta, el entrenador recibe 1 sobre inicial gratis.
- Un sobre contiene entre 3 y 5 Pokémon.
- Rarezas mínimas: `comun`, `raro`, `epico`.
- Probabilidad por defecto recomendada:
  - común: 70%
  - raro: 25%
  - épico: 5%
- Solo se pueden usar en batalla Pokémon del inventario del usuario.
- Recompensa por batalla:
  - ganador: +100 monedas
  - perdedor: +30 monedas (participación)
- Precio base recomendado de sobres:
  - básico: 100
  - avanzado: 250
- Si sale repetido, comportamiento obligatorio (elegir uno e implementarlo de forma consistente):
  - opción A: guardar copia adicional,
  - opción B: convertir repetido en monedas.

### 5.2 Equipos predefinidos reutilizables

- Cada entrenador puede guardar múltiples equipos con nombre único.
- Un equipo guardado debe tener exactamente 3 Pokémon del inventario actual.
- Si falta un Pokémon del equipo, el sistema debe rechazar `usar_equipo`.
- El entrenador puede reutilizar un equipo guardado en varias batallas.
- Debe existir validación para evitar equipos duplicados con el mismo nombre.

### 5.3 Inicio y fin de batalla

- Una batalla inicia solo con 2 entrenadores y equipo válido.
- Cada entrenador debe seleccionar exactamente 3 Pokémon.
- Gana quien debilite los 3 Pokémon rivales o por abandono.
- Si un jugador se desconecta, se espera 15 segundos; si no vuelve, pierde por abandono.

### 5.4 Orden de turnos

- Orden por `velocidad` del Pokémon activo.
- Empate de velocidad: resolver aleatoriamente.
- Tiempo máximo por turno: configurable (por defecto 20s).
- Si vence el tiempo, la acción del jugador es `pasar`.

### 5.5 Cálculo de daño

Se debe usar esta fórmula base:

```text
dano_base = trunc((((2 * nivel_atacante / 5) + 2) * poder_movimiento * (ataque / defensa)) / 50 + 2)
dano_final = trunc(dano_base * modificador_tipo * modificador_stab * factor_aleatorio)
```

Parámetros:

- `modificador_tipo`:
  - 2.0: fuerte
  - 0.5: débil
  - 1.0: neutro
- `modificador_stab`:
  - 1.5 si el tipo del movimiento coincide con tipo del atacante
  - 1.0 en otro caso
- `factor_aleatorio`: entre 0.85 y 1.00
- Daño mínimo por ataque exitoso: 1

### 5.6 Tipos (tabla mínima requerida)

Relaciones mínimas:

- Fuego > Planta, Hielo, Bicho
- Agua > Fuego, Roca, Tierra
- Planta > Agua, Roca, Tierra
- Eléctrico > Agua, Volador
- Roca > Fuego, Hielo, Volador, Bicho

Reglas:

- Si no hay relación definida, el daño es neutro (1.0).
- Si el defensor tiene 2 tipos, multiplicar modificadores.

### 5.7 Estadísticas, nivel y evolución

Estadísticas base mínimas por Pokémon:

- `salud_base`
- `ataque_base`
- `defensa_base`
- `velocidad_base`

Escalado por nivel:

```text
estadistica = base + (nivel * factor_crecimiento)
salud_maxima = salud_base + (nivel * factor_salud)
```

Valores por defecto recomendados:

- `factor_crecimiento = 2`
- `factor_salud = 3`
- nivel inicial: 5 o 10
- nivel máximo: 50

Experiencia y nivel:

```text
xp_requerida(nivel) = 50 + nivel * 25
```

Evolución:

- Si `nivel_actual >= nivel_evolucion`, evoluciona.
- Al evolucionar, cambia especie y estadísticas base.
- El nivel actual se conserva.

---

## 6. Concurrencia y Distribución

Implementación obligatoria:

- Cada batalla debe vivir en un proceso `GenServer` independiente.
- Las batallas activas deben ser gestionadas por un `DynamicSupervisor`.
- El sistema debe ejecutar batallas en al menos 2 nodos conectados.
- Debe existir una estrategia simple para asignar batallas al nodo menos cargado.

Resultado esperado:

- dos batallas distintas pueden correr al mismo tiempo sin interferencia,
- una falla de una batalla no debe tumbar el servidor completo.

---

## 7. Persistencia (Archivos)

Formato permitido: JSON o CSV (usar uno de forma consistente).

Archivos minimos:

- `data/trainers.dat`
  - usuario, clave, ELO, monedas, inventario, sobres_pendientes, equipos_guardados
- `data/pokemon.dat`
  - especies, tipos, estadísticas base, movimientos, evolución
- `data/tienda.dat`
  - tipos de sobre, precios, probabilidades
- `data/battles.log`
  - fecha, jugadores, ganador, nodo, duración, resumen

Requisito:

- inventario y monedas deben mantenerse entre ejecuciones del programa.

---

## 8. Arquitectura Recomendada

```text
proyecto_pokemon/
|-- lib/
|   |-- pokemon_battle/
|   |   |-- servidor.ex            # interfaz y enrutamiento de comandos
|   |   |-- gestor_entrenadores.ex # inicio de sesión, perfil, monedas, inventario
|   |   |-- sistema_sobres.ex      # compra/apertura de sobres
|   |   |-- gestor_salas.ex        # creacion/union de salas
|   |   |-- batalla.ex             # GenServer de batalla
|   |   |-- supervisor_batallas.ex # DynamicSupervisor de batallas
|   |   |-- motor_combate.ex       # daño, tipos, turnos
|   |   |-- progresion.ex          # xp, nivel, evolución
|   |   |-- persistencia.ex        # lectura/escritura de archivos
|   |   |-- cluster.ex             # nodos y asignación distribuida
|-- data/
|   |-- trainers.dat
|   |-- pokemon.dat
|   |-- tienda.dat
|   |-- battles.log
|-- test/
|-- mix.exs
```

---

## 9. Pruebas Mínimas Requeridas

Programar al menos 5 pruebas con ExUnit. Deben cubrir como mínimo:

1. Cálculo de daño con tipo fuerte/débil/neutro.
2. Validación de turnos por velocidad.
3. Asignación de monedas al terminar batalla.
4. Compra y apertura de sobres.
5. Evolución al alcanzar nivel objetivo.

---

## 10. Criterios de Aceptación

Se considera cumplido si:

1. Se pueden conectar 2 usuarios y jugar una batalla completa 1v1.
2. El sistema aplica daño, tipos, nivel y evolución según reglas definidas.
3. Los jugadores ganan monedas y pueden comprar/abrir sobres.
4. El inventario persiste al reiniciar la aplicación.
5. Se ejecutan dos batallas simultáneas correctamente.
6. Se demuestra ejecución distribuida en al menos 2 nodos.
7. Las pruebas unitarias pasan.

---

## 11. Flujo de Ejecución Esperado (Paso a Paso)

### 11.1 Preparación (sesión, sobres y sala)

1. Ana inicia sesión:
   - comando: `conectar ana 1234`
   - salida esperada: inicio de sesión exitoso, saldo inicial y sobre gratis disponible.
2. Luis inicia sesión:
   - comando: `conectar luis 1234`
   - salida esperada: inicio de sesión exitoso, saldo inicial y sobre gratis disponible.
3. Ana abre su sobre:
   - comando: `abrir_sobre ultimo`
   - salida esperada: 3-5 Pokémon agregados al inventario.
4. Luis abre su sobre:
   - comando: `abrir_sobre ultimo`
   - salida esperada: 3-5 Pokémon agregados al inventario.
5. Ana crea equipo reusable:
   - comando: `crear_equipo rapido charmander,pikachu,pidgey`
   - salida esperada: equipo guardado con nombre `rapido`.
6. Luis crea equipo reusable:
   - comando: `crear_equipo tanque squirtle,bulbasaur,geodude`
   - salida esperada: equipo guardado con nombre `tanque`.
7. Ana crea sala:
   - comando: `crear_sala modo=1v1 tiempo_turno=20`
   - salida esperada: `id_sala=S-1001`.
8. Luis entra a la sala:
   - comando: `unirse_sala S-1001`
   - salida esperada: jugador unido correctamente.
9. Carga de equipos guardados:
   - Ana: `usar_equipo rapido`
   - Luis: `usar_equipo tanque`
   - salida esperada: ambos equipos validados y listos para combate.
10. Inicio de combate:
   - comando: `iniciar_batalla S-1001`
   - salida esperada: batalla creada en un nodo (ej: `arena@host2`) y turno 1 iniciado.

### 11.2 Batalla completa de ejemplo (1v1, 3 Pokémon por jugador)

Estado inicial:

- Ana activo: `Charmander` (Fuego, Salud 39)
- Luis activo: `Bulbasaur` (Planta, Salud 45)

Turno 1:

- Ana: `ataque ascuas`
- Luis: `ataque latigo_cepa`
- Resolucion:
  - `Charmander` ataca primero por velocidad.
  - `ascuas` (Fuego > Planta, x2.0) deja a Bulbasaur en Salud 12.
  - Bulbasaur responde con `latigo_cepa` y deja a Charmander en Salud 30.

Turno 2:

- Ana: `ataque ascuas`
- Luis: `ataque latigo_cepa`
- Resolucion:
  - `ascuas` debilita a Bulbasaur (Salud 0).
  - Luis envía `Squirtle` automáticamente.

Turno 3:

- Ana: `ataque ascuas`
- Luis: `ataque pistola_agua`
- Resolucion:
  - `pistola_agua` (Agua > Fuego, x2.0) impacta fuerte.
  - Charmander queda en Salud 4 y luego es debilitado en el siguiente intercambio.
  - Ana cambia a `Pikachu`.

Turno 4:

- Ana: `ataque impactrueno`
- Luis: `ataque pistola_agua`
- Resolucion:
  - `impactrueno` (Electrico > Agua, x2.0) deja a Squirtle en Salud 10.
  - `pistola_agua` deja a Pikachu en Salud 20.

Turno 5:

- Ana: `ataque impactrueno`
- Luis: `cambiar geodude`
- Resolucion:
  - Luis cambia a `Geodude` para resistir mejor.
  - `impactrueno` hace daño bajo (neutro/débil según tabla implementada).

Turno 6:

- Ana: `cambiar pidgey`
- Luis: `ataque lanzarrocas`
- Resolucion:
  - Ana cambia a Pidgey.
  - `lanzarrocas` (Roca > Volador, x2.0) deja a Pidgey en Salud baja.

Turno 7:

- Ana: `ataque ráfaga`
- Luis: `ataque lanzarrocas`
- Resolucion:
  - Geodude resiste `ráfaga`.
  - `lanzarrocas` debilita a Pidgey.
  - Ana vuelve a `Pikachu`.

Turno 8:

- Ana: `ataque ataque_rapido`
- Luis: `ataque lanzarrocas`
- Resolucion:
  - Pikachu remata a Geodude que ya estaba debilitado.
  - Luis vuelve a `Squirtle` (Salud 10).

Turno 9:

- Ana: `ataque impactrueno`
- Luis: `ataque pistola_agua`
- Resolucion final:
  - `impactrueno` debilita a Squirtle.
  - Luis se queda sin Pokémon disponibles.
  - Ganadora: Ana.

### 11.3 Cierre de batalla (recompensas y persistencia)

1. El sistema muestra resumen:
   - ganador, turnos totales, nodo de ejecución, Pokémon sobrevivientes.
2. Recompensas:
   - Ana (ganadora): `+100` monedas.
   - Luis (participación): `+30` monedas.
3. Progresión:
   - se asigna XP a Pokémon participantes,
   - se recalcula nivel/evolución si aplica.
4. Persistencia obligatoria:
   - actualizar `data/trainers.dat` (elo, monedas, inventario, xp/nivel),
   - registrar entrada en `data/battles.log`.
5. Verificacion manual sugerida:
   - ejecutar `perfil` para ambos usuarios y confirmar monedas nuevas,
   - ejecutar `clasificacion` para ver cambios de posición.
